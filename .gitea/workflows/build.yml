name: Build OS

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  buildcompiler:
    name: Build Cross-Compiler & Toolchain
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v6
      with:
        submodules: recursive

    - name: Cache cross Folder
      id: cache-cross
      uses: actions/cache@v5
      with:
        path: tools/cross
        key: ${{ runner.os }}-cross-${{ hashFiles('tools/Makefile') }}

    - name: Run make ci-setup
      if: steps.cache-cross.outputs.cache-hit != 'true'
      run: |
        /usr/bin/make ci-setup

  compile:
    name: Build OS
    runs-on: ubuntu-latest
    needs: [buildcompiler]
    steps:
    - uses: actions/checkout@v6
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Cache cross Folder
      id: cache-cross
      uses: actions/cache@v5
      with:
        path: tools/cross
        key: ${{ runner.os }}-cross-${{ hashFiles('tools/Makefile') }}

    - name: Build AMD64 Debug
      if: always()
      run: /usr/bin/make __ci-amd64-debug

    - name: Build AMD64 Release
      if: always()
      run: /usr/bin/make __ci-amd64-release

    - name: Build i386 Debug
      if: always()
      run: /usr/bin/make __ci-i386-debug

    - name: Build i386 Release
      if: always()
      run: /usr/bin/make __ci-i386-release

    - name: Build ARM Debug
      if: always()
      run: /usr/bin/make __ci-arm-debug

    - name: Build ARM Release
      if: always()
      run: /usr/bin/make __ci-arm-release

    - name: Build AArch64 Debug
      if: always()
      run: /usr/bin/make __ci-aarch64-debug

    - name: Build AArch64 Release
      if: always()
      run: /usr/bin/make __ci-aarch64-release

    - name: Build Prepare Archive
      if: always()
      run: /usr/bin/make __ci-prepare-archive

    - name: Upload Artifact
      if: always()
      uses: actions/upload-artifact@v6
      with:
        name: artifacts
        path: artifacts/

  nightly:
    if: always()
    name: Upload Nightly Build to GitHub Releases
    runs-on: ubuntu-latest
    needs: [compile]
    steps:
    - uses: actions/checkout@v6
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Download All Builds
      uses: actions/download-artifact@v7

    - name: Update Nightly
      run: gh release upload nightly artifacts/* -R ${{github.repository}} --clobber

    env:
      GH_TOKEN: ${{ github.token }}
